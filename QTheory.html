<!DOCTYPE html>
<html><head>	<meta charset="utf-8"><title>Queuing Theory</title>
<style type="text/css">
	.bout1		{background-color:LightSkyBlue; height:35px; width:100px; font-size:80%;  border:0px solid black;}
	.bout2		{background-color:LightSkyBlue; height:15px; width:50px; font-size:80%;  border:0px solid black;}
	
	
</style>
<script type="text/javascript">

function Rectangle(c,x,y,l,h)				{c.fillRect (x,y,l,h);}
function Cercle(c,x,y,r) 					{c.beginPath();	c.arc(x,y,r, 0, Math.PI*2, true);	c.closePath(); c.fill();}
function Clean(c) 							{c.fillStyle = "LightSkyBlue";	c.fillRect (0,0,800,400); for(a=0;a<5;a++){ctx1.fillStyle = "#003754"; Rectangle(ctx1,70,27+70*a,10,45);}}
function set(a,b)							{document.getElementById(a).innerHTML=b;}
function getInput(a)						{if(document.getElementById(a)== null){input=1;}		else {input=document.getElementById(a).value; input=input.replace(/,/g, '.'); input=parseFloat(input);}		return input;}
var NbC=0;   var NbS=0; var STC=0;
var ClientArray=[];
var ServerArray=[];
var FileArray=[];
var Temp;

start = new Date().getTime();
var when 	=0;
var howmany =0;
next=1;
print = "";

//------SIMU VARIABLES------
//Serv_Time=6; // Service Time in Seconds.
var Serv_Time=[];
Serv_Time[0]=6;	// Service Time of Server 0
Serv_Time[1]=6;	// Service Time of Server 1
Serv_Time[2]=6;	// Service Time of Server 2
Serv_Time[3]=6;	// Service Time of Server 3
Serv_Time[4]=6;	// Service Time of Server 4
Arri_Rate=1; // Average Interval between 2 arrivals in seconds.

ARv=0;  //Arrival Rate variable or constant
STv=0;	//Service Time variable or constant
//--------------------------

function Init()	{
	ServerArray[0]	= new Server();  
	NbS++;	
	for(i=0;i<10;i++){FileArray[i]= new File(i);}  
	document.getElementById("Arate").value=Arri_Rate;  
	document.getElementById("Stime0").value=Serv_Time[0];  
	document.getElementById("Stime1").value=Serv_Time[1];
	document.getElementById("Stime2").value=Serv_Time[2];
	document.getElementById("Stime3").value=Serv_Time[3];
	document.getElementById("Stime4").value=Serv_Time[4];
	set("test3",Math.round(1/Arri_Rate*100)/100);
	//set("test2",Serv_Time.toFixed(2));
	ctx1 = document.getElementById('canvas1').getContext('2d'); 
	ctx2 = document.getElementById('canvas2').getContext('2d'); 
	Graph(0);
	drawShape();
}

function ServerAdd()		{if(NbS<5){ServerArray[NbS]  = new Server(NbS); NbS++;}}
function ServerRem()		{if(NbS>1){ Temp=ServerArray[NbS-1].Serving; ServerArray.pop(); NbS--; Dispatch(NbS);}}
function ClientAdd()		{ClientArray[NbC]= new Client(NbC);	Assign(NbC); NbC++;  start=new Date().getTime();}
function ClientRem(x)		{ClientArray[x].exist=0; if(j==STC+1){STC=x;}}

function ShortestFile()		{
	shortest=0; 	
	for(b=0;b<ServerArray.length;b++){
		if(FileArray[b].Line.length+ServerArray[b].busy<FileArray[shortest].Line.length+ServerArray[shortest].busy){
			shortest=b;
		}
	} 
	return shortest;
}

function Assign(f)	{
	Cli=ClientArray[f];
	if(document.getElementById("ONE").checked == true)	{Cli.row=9; FileArray[9].Line[FileArray[9].Line.length]=Cli.id;}
	if(document.getElementById("ONE").checked == false){Fil=ShortestFile(); Cli.row=Fil; FileArray[Fil].Line[FileArray[Fil].Line.length]=Cli.id;}
}

function Dispatch(a)		{  
	Cli=ClientArray[Temp]; Cli.Care=0;
	if(document.getElementById("ONE").checked == true) {Cli.row=9; FileArray[9].Line[FileArray[9].Line.length]=Cli.id;}
	
	if(document.getElementById("ONE").checked == false){Fil=ShortestFile(); Cli.row=Fil; FileArray[Fil].Line[FileArray[Fil].Line.length]=Cli.id;
												 while(FileArray[a].Line.length>0){
													Fil=ShortestFile();
													Cle=ClientArray[FileArray[a].Line[0]];
													Cle.row=Fil;  
													FileArray[Fil].Line[FileArray[Fil].Line.length]=Cle.id;  
													FileArray[a].Line.shift();
												}
	}
}

function Repatch(){
	if(document.getElementById("ONE").checked == true){
		for(b=0;b<ServerArray.length;b++){
			while(FileArray[b].Line.length>0){		
				Clo=ClientArray[FileArray[b].Line[0]];
				Clo.row=9;	
				FileArray[9].Line[FileArray[9].Line.length]=Clo.id;		
				FileArray[b].Line.shift();
			}
		}
	}
	
	if(document.getElementById("ONE").checked == false){
		while(FileArray[9].Line.length>0){ 
			Cly=ClientArray[FileArray[9].Line[0]]; 
			Fil=ShortestFile();   
			Cly.row=Fil;  
			FileArray[Fil].Line[FileArray[Fil].Line.length]=Cly.id;		
			FileArray[9].Line.shift(); 
		}   
	}
}



function DrawServ()			{for(m=1;m<=ServerArray.length;m++){ctx1.fillStyle ="#003754"; Cercle(ctx1,40,50+70*(m-1),20);}}

function DrawMult(){
	for(b=0;b<6;b++){
		if(ServerArray[b]!=undefined)if(ServerArray[b].busy==1){
			ctx1.fillStyle = "white"; Cercle(ctx1,110,b*70+50,20); 
			ServTimDisplay = Math.floor(ClientArray[ServerArray[b].Serving].ServTime);
			ctx1.fillStyle ="#003754";	ctx1.font="1em Helvetica"; ctx1.fillText(ServTimDisplay,103,b*70+55);
		}
		for(c=0;c<=FileArray[b].Line.length;c++){
			if(ClientArray[FileArray[b].Line[c]]!=undefined){
				ctx1.fillStyle = "white"; Cercle(ctx1,(c+1)*45+110,b*70+50,20);				
				ctx1.fillStyle ="#003754";	
				WT=ClientArray[FileArray[b].Line[c]].WaitTime;
				if(WT<10)	  {ctx1.fillStyle ="green";}
				else if(WT<30){ctx1.fillStyle ="orange";}
				else          {ctx1.fillStyle ="red";}
				ctx1.font="1em Helvetica"; ctx1.fillText(WT,(c+1)*45+103,b*70+55);
			}
		}
	}
}		
		
function DrawSimp(){
	for(b=0;b<6;b++){
		if(ServerArray[b]!=undefined){
			if(ServerArray[b].busy==1){
				ctx1.fillStyle = "white"; Cercle(ctx1,110,b*70+50,20); 
				ServTimDisplay = Math.floor(ClientArray[ServerArray[b].Serving].ServTime);
				ctx1.fillStyle ="#003754";	ctx1.font="1em Helvetica"; ctx1.fillText(ServTimDisplay,103,b*70+55);
			}
		}
	}
	for(b=0;b<FileArray[9].Line.length;b++){
		a=b+1;	
		ctx1.fillStyle = "white";		
		if(a==0){wherex=110;wherey=70+50;}	
		else{
			if(a%10==1){wherex=180+120*Math.floor(a/10);wherey=190;}	
			if(a%10==2){wherex=180+120*Math.floor(a/10);wherey=120;}	
			if(a%10==3){wherex=180+120*Math.floor(a/10);wherey=50;}	
			if(a%10==4){wherex=240+120*Math.floor(a/10);wherey=50;}	
			if(a%10==5){wherex=240+120*Math.floor(a/10);wherey=120;}	
			if(a%10==6){wherex=240+120*Math.floor(a/10);wherey=190;}	
			if(a%10==7){wherex=240+120*Math.floor(a/10);wherey=260;}	
			if(a%10==8){wherex=240+120*Math.floor(a/10);wherey=330;}	
			if(a%10==9){wherex=300+120*Math.floor(a/10);wherey=330;}	
			if(a%10==0){wherex=300+120*Math.floor((a-1)/10);wherey=260;}
		}	
		Cercle(ctx1,wherex,wherey,20);	
		WT=ClientArray[FileArray[9].Line[b]].WaitTime;
		     if(WT<10){ctx1.fillStyle ="green";}
		else if(WT<30){ctx1.fillStyle ="orange";}
		else          {ctx1.fillStyle ="red";}
		//ctx1.fillStyle ="#003754";		
		ctx1.font="1em Helvetica";		ctx1.fillText(WT,wherex-7,wherey+5);	 
	} 
	ctx1.fillStyle ="#003754";
	Rectangle(ctx1,150,20,1,140);	Rectangle(ctx1,150,220,60,1);	Rectangle(ctx1,210,80,1,280);	
	Rectangle(ctx1,270,20,1,280);	Rectangle(ctx1,330,80,1,280);	Rectangle(ctx1,390,20,1,280);	
	Rectangle(ctx1,450,80,1,280);	Rectangle(ctx1,510,20,1,280);	Rectangle(ctx1,570,80,1,280);	
	Rectangle(ctx1,630,20,1,280);	Rectangle(ctx1,690,80,1,280);	Rectangle(ctx1,750,20,1,280);
}

function PrintLogs(){
	print="<table><tr><td>ID</td><td>WAIT</td><td>Serv</td><td>Serv</td></tr>";	
	for(j=0;j<NbC;j++){
		if(ClientArray[j].exist==1){
			print+="<tr><td>"+j+"</td><td>"+ClientArray[j].WaitTime+"</td><td>"+ClientArray[j].row+"</td><td>"+ClientArray[j].ServTime+"</td></tr>";
		}
	}	
	set("M",print);
}



function UpA() {
	Arri_Rate=getInput("Arate"); 
	if(Arri_Rate>0){
		next=Arri_Rate; 
		if(ARv==1){next=randomExponential(1/Arri_Rate);} 
		set("test1",next);	
		set("test3",Math.round(1/Arri_Rate*100)/100);
	}
}

function UpS() {
	Serv_Time[0]=getInput("Stime0"); 
	Serv_Time[1]=getInput("Stime1");
	Serv_Time[2]=getInput("Stime2");
	Serv_Time[3]=getInput("Stime3");
	Serv_Time[4]=getInput("Stime4");
}



function Server(id){
	this.id			=id;
	this.busy		=0;
	this.Serving	=undefined;
}
  
function Client(id){
	this.id	  		= id;
	this.exist		= 1;
	this.Arrival	= new Date().getTime();
	this.End		= 0;
	this.WaitTime	= 0;
	this.StartServe = 0;
	this.ServTime	= 0;
	this.row		= 0;
	this.rank		= 0;
	this.Care		= 0;
}

function File(id){
	this.id			= id;
	this.Line		=[];
}

function randomExponential(rate, randomUniform) {
  rate = rate || 1;
  var U = randomUniform;
  if (typeof randomUniform === 'function') U = randomUniform();
  if (!U) U = Math.random();
  return -Math.log(U)/rate;
}

function RandomizeST(){
	UpS();  
	Serv_Time[0]=randomExponential(1/Serv_Time[0]);
	Serv_Time[1]=randomExponential(1/Serv_Time[1]);
	Serv_Time[2]=randomExponential(1/Serv_Time[2]);
	Serv_Time[3]=randomExponential(1/Serv_Time[3]);
	Serv_Time[4]=randomExponential(1/Serv_Time[4]);
}

function ConstOrVar(){
	slcted = document.getElementById("varST");
	STv= slcted.options[slcted.selectedIndex].value;
	slcted = document.getElementById("varAR");
	ARv= slcted.options[slcted.selectedIndex].value;
}

function Graph(x){
	if(x==0){
		ctx2.fillStyle = "DarkBlue";		ctx2.fillRect (0,0,800,300);
		ctx2.fillStyle = "White";			ctx2.fillRect (20,280,720,1);		ctx2.fillRect (20,30,1,250);
		ctx2.font = "10px Arial";			ctx2.fillText("LS",15,20);			ctx2.fillText("Time (s)",750,283);
		ctx2.fillText("0",10,290);			ctx2.fillText("100",120,290);		ctx2.fillText("200",220,290);		ctx2.fillText("300",320,290);	ctx2.fillText("400",420,290);	ctx2.fillText("500",520,290);
		ctx2.fillText("50",3,180);			ctx2.fillText("100",0,80);
	}
	ctx2.fillStyle = "Red";
	howmany=0;
	for(i=0;i<ClientArray.length;i++){if(ClientArray[i].exist==1){howmany++;}}
	ctx2.fillRect (20+when,280-(howmany*2),2,2);
}




function drawShape(){
	if(new Date().getTime() > start+1000*next)	{ClientAdd(); UpA(); when++; start=new Date().getTime();  }	
	
	set("test1",next.toFixed(2));
	Clean(ctx1); 
	DrawServ();
	ConstOrVar();
	if(document.getElementById("log").checked == true){PrintLogs();} else{set("M","");}
	
	for(j=STC;j<NbC;j++){if(ClientArray[j].exist==1){ClientArray[j].WaitTime=Math.round(((new Date().getTime())-ClientArray[j].Arrival)/1000);}} //Update Wait Time
	
	for(j=0;j<ServerArray.length;j++){
		if(ServerArray[j].busy==0 && (FileArray[9].Line.length>0 || FileArray[j].Line.length>0)){
			if(document.getElementById("ONE").checked == true) {ServerArray[j].Serving=FileArray[9].Line[0]; FileArray[9].Line.shift(); ServerArray[j].busy=1;}
			if(document.getElementById("ONE").checked == false){ServerArray[j].Serving=FileArray[j].Line[0]; FileArray[j].Line.shift(); ServerArray[j].busy=1;}
		}
		
		if(ClientArray[ServerArray[j].Serving] != undefined){
				Cla=ClientArray[ServerArray[j].Serving]; 
				if(Cla.Care==0){Cla.StartServe=new Date().getTime(); Cla.Care=1; }
				if(Cla.Care==1){Cla.ServTime=((new Date().getTime())-Cla.StartServe+10)/1000;}
				if(Cla.ServTime>=Serv_Time[j])
				{
					Cla.End=new Date().getTime();
					ServerArray[j].busy=0; ClientRem(Cla.id); 
					if(STv==1){RandomizeST();} else{UpS();}
				}
		}
	}
	
	if(document.getElementById("ONE").checked == true)	{DrawSimp();}
	if(document.getElementById("ONE").checked == false)	{DrawMult();}
	
	set("S","Servers: "+NbS+" <br>"); 
	Graph(1);
	requestAnimationFrame(drawShape);	
}

</script></head>
<body onload="Init();">
<table style="width:988px;border:1px solid #FFF;border-collapse:collapse;"><tr style="background-color:#003754;color:white"><td style="font-size:2em;">Queuing Theory</td><td style="font-size:0.8em; text-align:left;">Design & Code : Jordi Weiss  <br>  Based on "Operations Management" by Prof. Suzanne de Treville <br> Universite de Lausanne</td></tr></table>

<table><tr><td><table>
<tr><td style="height:65px; border:0px solid black">Service Time: <input  class="bout2" id="Stime0"  value="5" style="transform: scale(1)" onchange="UpS()" /> sec.</td></tr>
<tr><td style="height:65px; border:0px solid black">Service Time: <input  class="bout2" id="Stime1"  value="5" style="transform: scale(1)" onchange="UpS()" /> sec.</td></tr>
<tr><td style="height:65px; border:0px solid black">Service Time: <input  class="bout2" id="Stime2"  value="5" style="transform: scale(1)" onchange="UpS()" /> sec.</td></tr>
<tr><td style="height:65px; border:0px solid black">Service Time: <input  class="bout2" id="Stime3"  value="5" style="transform: scale(1)" onchange="UpS()" /> sec.</td></tr>
<tr><td style="height:65px; border:0px solid black">Service Time: <input  class="bout2" id="Stime4"  value="5" style="transform: scale(1)" onchange="UpS()" /> sec.</td></tr>
<tr><td style="height:20px; border:0px solid black"></td></tr>
</table></td>
<td><canvas id="canvas1" width="800" height="400" ></canvas><br></td>
</tr></table>

<table>
	<tr><td><b>Setting</b></td>  <td></td> <td><b>Action</b></td>   <td><b>Logs <input id="log"  type="checkbox"  style="transform: scale(1)"> </b></td> </tr>
	<tr>
		<td style="width:300px; vertical-align:top"><span id="S"> </span> 
		<table>
		<tr><td style="width:120px;"> Service Time:  		</td><td> </td><td> 	<br><select id="varST"><option selected value="0">Constant</option><option value="1">Variable</option></select> <br><br></td></tr>  		<tr><td></td><td></td><td></td></tr>
		<tr><td style="width:120px;"> Inter-arrival time:   </td><td><input  class="bout2" id="Arate"  value="5" style="transform: scale(1)" onchange="UpA()" /> sec. </td><td>		<br><select id="varAR"><option selected value="0">Constant</option><option value="1">Variable</option></select> <br><br></td></tr>
		<tr><td style="margin-bottom:-5px;" colspan="2">		  (Arrival Rate:  		<span id="test3"> </span> /sec.)</td><td></td></tr>
		</table>
		<br><br><br></td><td style="width:100px;"> &nbsp</td>
		<td style="width:240px; vertical-align:top">
			<input type=button 	class="bout1" value="Server++"  onclick="ServerAdd();"><br><br>
			<input type=button 	class="bout1" value="Server--"  onclick="ServerRem();"><br><br>
			One Queue:<input id="ONE"  type="checkbox"  onchange="Repatch()" style="transform: scale(1.5)">
			
		</td>
		<td style="vertical-align:top"><span id="M"> </span>  Next in: <span id="test1"> </span>    <br> <span id="test2"> </span> </td> 
	</tr>
</table>
<canvas id="canvas2" width="800" height="300" ></canvas>

</body> 
